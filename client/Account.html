<!-- @format -->

<script>
  import {onMount, onDestroy} from 'svelte'

  import * as toast from './toast'
  import QR from './QR.html'
  import account from './accountStore'

  var unsubscribe = () => {}
  var es

  onMount(() => {
    unsubscribe = account.subscribe(({session}) => {
      if (session && !es) {
        es = new EventSource('/lnurl/session?src=comp&session=' + session)
        es.onerror = e => console.log('Account component sse error', e.data)
        es.addEventListener('withdraw', e => {
          let data = JSON.parse(e.data)
          toast.info(`successfully withdrawn ${data.amount} msatoshi`)
          toast.info(`balance is now ${data.new_balance} msatoshi`)
        })
      }
    })
  })

  onDestroy(() => {
    if (es) {
      es.close()
    }
    unsubscribe()
  })

  async function logout() {
    account.reset()
    await fetch('/lnurl/logout')
    toast.info('logged out!')
  }
</script>

<style>
  button {
    cursor: pointer;
    margin: 12px;
    padding: 12px;
    background-color: var(--yellow);
    float: right;
  }
</style>

<div class="center">
  {#if $account.id}
  <p>Logged as <b>{$account.id}</b>.</p>
  <p>Your balance is <b>{($account.balance / 1000).toFixed(3)}</b> satoshi.</p>
  {#if $account.balance > 0 && $account.lnurl.withdraw}
  <QR value="{$account.lnurl.withdraw}" />
  <p>Scan to withdraw.</p>
  {/if}
  <div><button on:click="{logout}">logout</button></div>
  {:else if $account.lnurl.auth}
  <QR value="{$account.lnurl.auth}" />
  <p>Scan to login.</p>
  {/if}
</div>
